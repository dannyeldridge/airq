<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AirQ Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      :root {
        /* Color palette */
        --alice-blue: #E8F1F2;
        --celadon: #B3EFB2;
        --cambridge-blue: #7A9E7E;
        --brunswick-green: #31493C;
        --rich-black: #001A23;
        
        /* Semantic colors */
        --primary-bg: var(--alice-blue);
        --secondary-bg: var(--cambridge-blue);
        --accent-bg: var(--brunswick-green);
        --text-primary: var(--rich-black);
        --text-secondary: var(--brunswick-green);
        --text-muted: var(--cambridge-blue);
        --text-on-dark: var(--alice-blue);
        --border-light: var(--cambridge-blue);
        --border-accent: var(--brunswick-green);
        
        /* Gradients */
        --bg-gradient: linear-gradient(135deg, var(--alice-blue) 0%, var(--cambridge-blue) 50%, var(--brunswick-green) 100%);
        --modal-gradient: linear-gradient(135deg, var(--brunswick-green) 0%, var(--cambridge-blue) 100%);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-gradient);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: var(--text-primary);
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 26, 35, 0.2);
        font-weight: 600;
      }

      .device-selector {
        margin: 10px 0;
      }

      .device-selector select {
        background: rgba(0, 26, 35, 0.1);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        color: var(--text-primary);
        padding: 8px 12px;
        font-size: 1rem;
        cursor: pointer;
        backdrop-filter: blur(4px);
      }

      .device-selector select option {
        background: var(--accent-bg);
        color: var(--text-on-dark);
      }

      .last-updated {
        font-size: 1rem;
        opacity: 0.9;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: rgba(232, 241, 242, 0.95);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 26, 35, 0.15);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(122, 158, 126, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
      }

      .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(49, 73, 60, 0.25);
        border-color: var(--border-light);
      }

      .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .metric-label {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-bottom: 5px;
        font-weight: 500;
      }

      .metric-unit {
        font-size: 0.9rem;
        color: var(--text-muted);
      }

      .pm2-ideal {
        color: #2196F3;
      }
      .pm2-elevated {
        color: #4caf50;
      }
      .pm2-moderate {
        color: #FFEB3B;
      }
      .pm2-sensitive {
        color: #FF9800;
      }
      .pm2-unhealthy {
        color: #f44336;
      }
      .pm2-very-unhealthy {
        color: #9C27B0;
      }

      .co2-excellent {
        color: #00c853;
      }
      .co2-acceptable {
        color: #f2de2a;
      }
      .co2-not-ideal {
        color: #ff6f00;
      }
      .co2-avoid {
        color: #d50000;
      }
      .co2-unhealthy {
        color: #6a1b9a;
      }
      .co2-very-unhealthy {
        color: #5d4037;
      }

      .tvoc-good {
        color: #4caf50;
      }
      .tvoc-moderate {
        color: #ff9800;
      }
      .tvoc-poor {
        color: #f44336;
      }

      .nox-good {
        color: #4caf50;
      }
      .nox-moderate {
        color: #ff9800;
      }
      .nox-poor {
        color: #f44336;
      }

      .error-message {
        background: rgba(232, 241, 242, 0.9);
        color: var(--text-secondary);
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        text-align: center;
        border-left: 4px solid var(--border-light);
        backdrop-filter: blur(4px);
      }

      .error-message code {
        background: rgba(0, 26, 35, 0.1);
        color: var(--text-primary);
        padding: 8px 12px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        display: block;
        margin-top: 10px;
        text-align: left;
        word-wrap: break-word;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-primary);
        font-size: 1.2rem;
        font-weight: 500;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
      }

      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        width: 90%;
        max-width: 800px;
        border-radius: 15px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s;
      }

      .modal-header {
        background: var(--modal-gradient);
        color: var(--text-on-dark);
        padding: 20px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }

      .close {
        color: var(--text-on-dark);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
      }

      .close:hover {
        opacity: 1;
      }

      .time-buttons {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid #eee;
      }

      .time-btn {
        background: var(--secondary-bg);
        color: var(--text-on-dark);
        border: none;
        padding: 10px 20px;
        margin: 0 5px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 500;
      }

      .time-btn:hover {
        background: var(--accent-bg);
        transform: translateY(-2px);
      }

      .time-btn.active {
        background: var(--accent-bg);
        box-shadow: 0 3px 10px rgba(49, 73, 60, 0.3);
      }

      .chart-container {
        padding: 20px;
        height: 400px;
        position: relative;
      }

      .average-indicator {
        padding: 15px 20px;
        text-align: center;
        border-top: 1px solid var(--primary-bg);
        font-size: 16px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }

        .metrics-grid {
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
        }

        .metric-card {
          padding: 20px;
        }

        .metric-value {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üå¨Ô∏è AirQ Dashboard</h1>
        <div class="device-selector">
          <select id="deviceSelect">
            <option value="">All Devices</option>
          </select>
        </div>
        <div class="last-updated" id="lastUpdated">Loading...</div>
      </div>

      <div id="errorMessage" class="error-message" style="display: none"></div>
      <div id="loading" class="loading">Loading air quality data...</div>

      <div id="dashboard" style="display: none">
        <div class="metrics-grid">
          <div
            class="metric-card"
            data-metric="pm2"
            data-unit="Œºg/m¬≥"
            data-label="PM2.5"
          >
            <div class="metric-value" id="pm2Value">--</div>
            <div class="metric-label">PM2.5</div>
            <div class="metric-unit">Œºg/m¬≥</div>
          </div>

          <div
            class="metric-card"
            data-metric="co2"
            data-unit="ppm"
            data-label="CO‚ÇÇ"
          >
            <div class="metric-value" id="co2Value">--</div>
            <div class="metric-label">CO‚ÇÇ</div>
            <div class="metric-unit">ppm</div>
          </div>

          <div
            class="metric-card"
            data-metric="temperature"
            data-unit="¬∞F"
            data-label="Temperature"
          >
            <div class="metric-value" id="tempValue">--</div>
            <div class="metric-label">Temperature</div>
            <div class="metric-unit">¬∞F</div>
          </div>

          <div
            class="metric-card"
            data-metric="humidity"
            data-unit="%"
            data-label="Humidity"
          >
            <div class="metric-value" id="humidityValue">--</div>
            <div class="metric-label">Humidity</div>
            <div class="metric-unit">%</div>
          </div>

          <div
            class="metric-card"
            data-metric="tvoc"
            data-unit="index"
            data-label="TVOC"
          >
            <div class="metric-value" id="tvocValue">--</div>
            <div class="metric-label">TVOC</div>
            <div class="metric-unit">index</div>
          </div>

          <div
            class="metric-card"
            data-metric="nox"
            data-unit="index"
            data-label="NOx"
          >
            <div class="metric-value" id="noxValue">--</div>
            <div class="metric-label">NOx</div>
            <div class="metric-unit">index</div>
          </div>
        </div>
      </div>

      <!-- Modal for time series chart -->
      <div id="chartModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2 id="modalTitle">Metric History</h2>
            <span class="close">&times;</span>
          </div>
          <div class="time-buttons">
            <button class="time-btn active" data-range="8h">
              Last 8 hours (5 min)
            </button>
            <button class="time-btn" data-range="24h">
              Last 24 hours (5 min)
            </button>
            <button class="time-btn" data-range="1w">Last week (20 min)</button>
          </div>
          <div class="chart-container">
            <canvas id="timeSeriesChart"></canvas>
          </div>
          <div class="average-indicator">
            <span id="averageLabel"></span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Define colors as variables
      const COLORS = {
        pm2: {
          ideal: "#2196F3",
          elevated: "#4caf50",
          moderate: "#FFEB3B",
          sensitive: "#FF9800",
          unhealthy: "#f44336",
          veryUnhealthy: "#9C27B0"
        },
        co2: {
          excellent: "#00c853",
          acceptable: "#f2de2a",
          notIdeal: "#ff6f00",
          avoid: "#d50000",
          unhealthy: "#6a1b9a",
          veryUnhealthy: "#5d4037"
        },
        tvoc: {
          good: "#4caf50",
          moderate: "#ff9800",
          poor: "#f44336"
        },
        nox: {
          good: "#4caf50",
          moderate: "#ff9800",
          poor: "#f44336"
        },
        temperature: {
          cool: "#2196F3",
          comfortable: "#4CAF50",
          warm: "#FF9800",
          hot: "#F44336"
        },
        humidity: {
          dry: "#FF9800",
          optimal: "#4CAF50",
          humid: "#FF9800"
        }
      };

      function showError(message) {
        document.getElementById("errorMessage").innerHTML = message;
        document.getElementById("errorMessage").style.display = "block";
        document.getElementById("loading").style.display = "none";
      }

      function hideError() {
        document.getElementById("errorMessage").style.display = "none";
      }

      function formatTimestamp(timestamp) {
        // Timestamp is UTC from backend, convert to user's local timezone
        const date = new Date(timestamp + 'Z'); // Add Z to indicate UTC
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "numeric",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });
      }

      function getPM2Color(value) {
        if (value <= 5.0) return "pm2-ideal";
        if (value <= 10.0) return "pm2-elevated";
        if (value <= 15.0) return "pm2-moderate";
        if (value <= 25.0) return "pm2-sensitive";
        if (value <= 35.0) return "pm2-unhealthy";
        return "pm2-very-unhealthy";
      }

      function getCO2Color(value) {
        if (value <= 800) return "co2-excellent";
        if (value <= 1000) return "co2-acceptable";
        if (value <= 1500) return "co2-not-ideal";
        if (value <= 2000) return "co2-avoid";
        if (value <= 3000) return "co2-unhealthy";
        return "co2-very-unhealthy";
      }

      function getTVOCColor(value) {
        if (value <= 150) return "tvoc-good";
        if (value <= 500) return "tvoc-moderate";
        return "tvoc-poor";
      }

      function getNOxColor(value) {
        if (value <= 20) return "nox-good";
        if (value <= 100) return "nox-moderate";
        return "nox-poor";
      }

      async function loadDevices() {
        try {
          const response = await fetch("/api/devices");
          if (!response.ok) {
            throw new Error("Failed to fetch devices");
          }

          const devices = await response.json();
          const select = document.getElementById("deviceSelect");
          
          // Clear existing options except "All Devices"
          while (select.children.length > 1) {
            select.removeChild(select.lastChild);
          }
          
          if (devices.length === 0) {
            // No devices configured
            const option = document.createElement("option");
            option.value = "";
            option.textContent = "No devices configured";
            option.disabled = true;
            select.appendChild(option);
          } else {
            // Add device options
            devices.forEach(device => {
              const option = document.createElement("option");
              option.value = device.id;
              option.textContent = device.name;
              select.appendChild(option);
            });
          }
          
        } catch (error) {
          console.error("Error loading devices:", error);
        }
      }

      async function loadCurrentData() {
        try {
          const url = selectedDeviceId ? `/api/current/${selectedDeviceId}` : "/api/current";
          const response = await fetch(url);
          if (!response.ok) {
            if (response.status === 404) {
              showError("No devices configured. Add a device using:<br><code>python manage.py add-device airgradient \"Device Name\" --token TOKEN --location LOCATION --validate</code>");
              return;
            }
            throw new Error("Failed to fetch current data");
          }

          const data = await response.json();

          // Update current values
          document.getElementById("pm2Value").textContent =
            data.pm2 !== null && data.pm2 !== undefined
              ? data.pm2.toFixed(1)
              : "--";
          document.getElementById("co2Value").textContent =
            data.co2 !== null && data.co2 !== undefined ? data.co2 : "--";
          // Convert Celsius to Fahrenheit
          const tempF =
            data.temperature !== null && data.temperature !== undefined
              ? (data.temperature * 9) / 5 + 32
              : null;
          document.getElementById("tempValue").textContent =
            tempF !== null ? tempF.toFixed(1) : "--";
          document.getElementById("humidityValue").textContent =
            data.humidity !== null && data.humidity !== undefined
              ? data.humidity.toFixed(0)
              : "--";
          document.getElementById("tvocValue").textContent =
            data.tvoc !== null && data.tvoc !== undefined ? data.tvoc : "--";
          document.getElementById("noxValue").textContent =
            data.nox !== null && data.nox !== undefined ? data.nox : "--";

          // Apply color coding
          if (data.pm2 !== null && data.pm2 !== undefined) {
            document.getElementById(
              "pm2Value"
            ).className = `metric-value ${getPM2Color(data.pm2)}`;
          }
          if (data.co2 !== null && data.co2 !== undefined) {
            document.getElementById(
              "co2Value"
            ).className = `metric-value ${getCO2Color(data.co2)}`;
          }
          if (data.tvoc !== null && data.tvoc !== undefined) {
            document.getElementById(
              "tvocValue"
            ).className = `metric-value ${getTVOCColor(data.tvoc)}`;
          }
          if (data.nox !== null && data.nox !== undefined) {
            document.getElementById(
              "noxValue"
            ).className = `metric-value ${getNOxColor(data.nox)}`;
          }

          // Update timestamp
          const deviceInfo = data.device_name ? ` (${data.device_name})` : "";
          document.getElementById(
            "lastUpdated"
          ).textContent = `Last updated: ${formatTimestamp(data.timestamp)}${deviceInfo}`;

          hideError();
          document.getElementById("loading").style.display = "none";
          document.getElementById("dashboard").style.display = "block";
        } catch (error) {
          console.error("Error loading current data:", error);
          showError("Failed to load current air quality data");
        }
      }

      // Chart variables
      let timeSeriesChart = null;
      let currentMetric = null;
      let currentRange = "8h";
      let selectedDeviceId = null;

      // Modal functions
      function openModal(metric, unit, label) {
        currentMetric = metric;
        document.getElementById("modalTitle").textContent = `${label} History`;
        document.getElementById("chartModal").style.display = "block";
        loadTimeSeriesData(currentRange);
      }

      function closeModal() {
        document.getElementById("chartModal").style.display = "none";
        if (timeSeriesChart) {
          timeSeriesChart.destroy();
          timeSeriesChart = null;
        }
      }

      // Load time series data
      async function loadTimeSeriesData(range) {
        currentRange = range;

        // Update active button
        document.querySelectorAll(".time-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.range === range);
        });

        try {
          // Determine hours based on range
          let hours;
          switch (range) {
            case "8h":
              hours = 8;
              break;
            case "24h":
              hours = 24;
              break;
            case "1w":
              hours = 168;
              break;
          }

          const url = selectedDeviceId ? `/api/history/${hours}/${selectedDeviceId}` : `/api/history/${hours}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error("Failed to fetch data");

          const data = await response.json();

          // Process data based on range
          const processedData = processDataForRange(data, range, currentMetric);

          // Create or update chart
          createTimeSeriesChart(processedData, currentMetric);

          // Update average
          updateAverage(processedData.values, currentMetric);
        } catch (error) {
          console.error("Error loading time series data:", error);
          showError("Failed to load historical data");
        }
      }

      function processDataForRange(data, range, metric) {
        const labels = [];
        const values = [];

        // For temperature, convert to Fahrenheit
        const needsFahrenheit = metric === "temperature";

        data.forEach((item) => {
          const timestamp = new Date(item.timestamp + 'Z'); // Add Z to indicate UTC
          let value = item[metric];

          if (value !== null && value !== undefined) {
            if (needsFahrenheit) {
              value = (value * 9) / 5 + 32;
            }

            labels.push(timestamp);
            values.push(value);
          }
        });

        return { labels, values };
      }

      function createTimeSeriesChart(data, metric) {
        const ctx = document.getElementById("timeSeriesChart").getContext("2d");

        if (timeSeriesChart) {
          timeSeriesChart.destroy();
        }

        // Create datasets for each color range
        const datasets = createColoredDatasets(data, metric);

        timeSeriesChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: data.labels,
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: "index",
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    if (context.parsed.y === null) return null;
                    const unit = document.querySelector(
                      `[data-metric="${metric}"]`
                    ).dataset.unit;
                    return `${context.parsed.y.toFixed(1)} ${unit}`;
                  },
                  filter: function (tooltipItem) {
                    return tooltipItem.parsed.y !== null;
                  },
                },
              },
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: currentRange === "1w" ? "day" : "hour",
                  displayFormats: {
                    hour: "h:mm a",
                    day: "MMM d",
                  },
                },
                grid: {
                  display: false,
                },
              },
              y: {
                beginAtZero: metric !== "temperature",
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                  drawBorder: false,
                },
              },
            },
          },
        });
      }

      function createColoredDatasets(data, metric) {
        // Create a dataset for each color range
        const ranges = getMetricRanges(metric);
        const datasets = [];

        ranges.forEach((range, index) => {
          const dataset = {
            label: range.label,
            data: data.values.map((value, i) => {
              // Only show value if it's in this range
              if (
                value !== null &&
                value !== undefined &&
                isInRange(value, range, metric)
              ) {
                return value;
              }
              return null;
            }),
            borderColor: range.color,
            backgroundColor: range.color + "40", // Add transparency
            fill: "origin",
            stepped: "middle",
            borderWidth: 0,
            pointRadius: 0,
            pointHoverRadius: 0,
            tension: 0,
          };
          datasets.push(dataset);
        });

        return datasets;
      }

      function getMetricRanges(metric) {
        switch (metric) {
          case "pm2":
            return [
              { label: "Ideal (WHO)", color: COLORS.pm2.ideal, min: 0, max: 5.0 },
              { label: "Elevated", color: COLORS.pm2.elevated, min: 5.0, max: 10.0 },
              { label: "Moderate", color: COLORS.pm2.moderate, min: 10.0, max: 15.0 },
              { label: "Sensitive Groups", color: COLORS.pm2.sensitive, min: 15.0, max: 25.0 },
              { label: "Unhealthy", color: COLORS.pm2.unhealthy, min: 25.0, max: 35.0 },
              { label: "Very Unhealthy", color: COLORS.pm2.veryUnhealthy, min: 35.0, max: Infinity },
            ];
          case "co2":
            return [
              { label: "Excellent", color: COLORS.co2.excellent, min: 0, max: 800 },
              { label: "Acceptable", color: COLORS.co2.acceptable, min: 800, max: 1000 },
              { label: "Not Ideal", color: COLORS.co2.notIdeal, min: 1000, max: 1500 },
              {
                label: "To be Avoided",
                color: COLORS.co2.avoid,
                min: 1500,
                max: 2000,
              },
              { label: "Unhealthy", color: COLORS.co2.unhealthy, min: 2000, max: 3000 },
              {
                label: "Very Unhealthy",
                color: COLORS.co2.veryUnhealthy,
                min: 3000,
                max: Infinity,
              },
            ];
          case "temperature":
            return [
              { label: "Cool", color: COLORS.temperature.cool, min: -Infinity, max: 68 },
              { label: "Comfortable", color: COLORS.temperature.comfortable, min: 68, max: 77 },
              { label: "Warm", color: COLORS.temperature.warm, min: 77, max: 86 },
              { label: "Hot", color: COLORS.temperature.hot, min: 86, max: Infinity },
            ];
          case "humidity":
            return [
              { label: "Dry", color: COLORS.humidity.dry, min: 0, max: 30 },
              { label: "Optimal", color: COLORS.humidity.optimal, min: 30, max: 60 },
              { label: "Humid", color: COLORS.humidity.humid, min: 60, max: 100 },
            ];
          case "tvoc":
            return [
              { label: "Good", color: COLORS.tvoc.good, min: 0, max: 150 },
              { label: "Moderate", color: COLORS.tvoc.moderate, min: 150, max: 500 },
              { label: "Poor", color: COLORS.tvoc.poor, min: 500, max: Infinity },
            ];
          case "nox":
            return [
              { label: "Good", color: COLORS.nox.good, min: 0, max: 20 },
              { label: "Moderate", color: COLORS.nox.moderate, min: 20, max: 100 },
              { label: "Poor", color: COLORS.nox.poor, min: 100, max: Infinity },
            ];
          default:
            return [
              {
                label: "Value",
                color: "#999999",
                min: -Infinity,
                max: Infinity,
              },
            ];
        }
      }

      function isInRange(value, range, metric) {
        if (metric === "temperature" || metric === "humidity") {
          return value >= range.min && value < range.max;
        }
        return value > range.min && value <= range.max;
      }

      function updateAverage(values, metric) {
        if (values.length === 0) {
          document.getElementById("averageLabel").textContent =
            "No data available";
          return;
        }

        const average =
          values.reduce((sum, val) => sum + val, 0) / values.length;
        const unit = document.querySelector(`[data-metric="${metric}"]`).dataset
          .unit;

        let displayValue;
        if (metric === "humidity" || metric === "tvoc" || metric === "nox") {
          displayValue = Math.round(average);
        } else {
          displayValue = average.toFixed(1);
        }

        document.getElementById(
          "averageLabel"
        ).textContent = `${currentRange} Average: ${displayValue} ${unit}`;
      }

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        loadDevices();
        loadCurrentData();

        // Refresh current data every 2 minutes
        setInterval(loadCurrentData, 120000);
        
        // Device selector change handler
        document.getElementById("deviceSelect").addEventListener("change", function() {
          selectedDeviceId = this.value || null;
          loadCurrentData();
        });

        // Add click handlers to metric cards
        document.querySelectorAll(".metric-card").forEach((card) => {
          card.addEventListener("click", function () {
            const metric = this.dataset.metric;
            const unit = this.dataset.unit;
            const label = this.dataset.label;
            openModal(metric, unit, label);
          });
        });

        // Close modal handlers
        document.querySelector(".close").addEventListener("click", closeModal);
        document
          .getElementById("chartModal")
          .addEventListener("click", function (e) {
            if (e.target === this) closeModal();
          });

        // Time range button handlers
        document.querySelectorAll(".time-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            loadTimeSeriesData(this.dataset.range);
          });
        });
      });
    </script>
  </body>
</html>
